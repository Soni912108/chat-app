<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <script defer src="/public/js/navbar.js"></script>
    <script defer src="/public/js/profile.js"></script>
</head>
<body>
    <nav class="profile-nav">
        <div class="nav-left-buttons">
            <button class="nav-button" onclick="goBack()">Back to Dashboard</button>
            <button class="nav-button" onclick="logout()" id="logout">Logout</button>
            <button onclick="gotoNotification()" class="nav-button" id="notification">Notification</button>
        </div>
        <div class="nav-right-buttons">
            <button class="nav-button room-action-button" onclick="updateUserProfile()">Update Profile</button>
        </div>
    </nav>
    
    <div class="profile-container">
        <h1 class="profile-title">Your Profile</h1>
        <div class="profile-avatar">
            <img src="" alt="Profile Avatar" id="profile-avatar">
        </div>
        <div class="profile-details">
            <h3 id="username" class="profile-username">Username</h3>
            <p id="email" class="profile-email"></p>
            <p id="joined-date" class="profile-joined-date"></p>
            <p id="last-login" class="profile-last-login">Last login: </p>
            <p class="profile-info">Rooms you have created:</p>
            <ul id="rooms-created" class="room-list"></ul>
        </div>
        <div class="activity-stats">
            <h2>Activity Statistics</h2>
            <p id="rooms-created-count">Rooms Created: </p>
            <p id="rooms-joined-count">Rooms Joined: </p>
            <p id="messages-sent-count">Messages Sent: </p>
        </div>
        <div class="recent-activity">
            <h2>Recent Activity</h2>
            <ul id="recent-activity-list"></ul>
        </div>
        <div class="settings-preferences">
            <h2>Settings and Preferences</h2>
            <form id="settings-form">
                <label for="theme">Theme:</label>
                <select name="theme" id="theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
                <button type="submit" class="settings-button">Update Settings</button>
            </form>
        </div>                
    </div>

</body>


<script>
    document.getElementById('settings-form').addEventListener('submit', async (event) => {
    event.preventDefault();

    const theme = document.getElementById('theme').value;

    // Save settings to server
    try {
        const response = await fetch('/api/user/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + sessionStorage.getItem('token'),
            },
            body: JSON.stringify({ theme: theme }),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message);
        }

        const data = await response.json();
        alert('Settings updated successfully!');
        applySettings(data.settings); // Apply settings to the page
    } catch (error) {
        console.error('Error updating settings:', error);
        alert('Error updating settings:', error.message);
    }
    });

    // Function to apply settings to the page
    function applySettings(settings) {
    if (settings.theme === 'dark') {
        document.body.classList.add('dark-theme');
        document.body.classList.remove('light-theme');
    } else {
        document.body.classList.add('light-theme');
        document.body.classList.remove('dark-theme');
    }
    }

    // Fetch and apply settings when the page loads
    document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/user/settings', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + sessionStorage.getItem('token'),
            },
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message);
        }

        const data = await response.json();
        document.getElementById('theme').value = data.settings.theme;
        applySettings(data.settings);
    } catch (error) {
        console.error('Error fetching settings:', error);
    }
    });

</script>
</html>
